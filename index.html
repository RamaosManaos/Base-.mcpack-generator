<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Base .mcpack Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

  <style>
    @font-face { 
      font-family: 'MojanglesLocal'; 
      src: url('./mojangles.ttf') format('truetype'),
           url('mojangles.ttf') format('truetype');
      font-display: swap;
    }

    :root {
      --bg-color: #0b0e14; --card-bg: #161b22; --panel-bg: #1c2128;
      --text-color: #f0f6fc; --text-dim: #8b949e; --border-color: #30363d;
      --accent-color: #58a6ff; --danger: #ff4444; --input-bg: #0d1117;
      /* Eliminado el verde, ahora usamos el accent para éxito también si se requiere */
      --success: #58a6ff; 
    }

    body.light {
      --bg-color: #f6f8fa; --card-bg: #ffffff; --panel-bg: #f0f2f5;
      --text-color: #1f2328; --text-dim: #57606a; --border-color: #d0d7de;
      --accent-color: #0969da; --input-bg: #ffffff;
      --success: #0969da;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-color); color: var(--text-color); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; transition: background 0.4s; }

    .top-controls { width: 100%; max-width: 400px; display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 15px; position: relative; }
    .square-btn { width: 48px; height: 48px; border-radius: 12px; border: 1px solid var(--border-color); cursor: pointer; background: var(--card-bg); display: flex; justify-content: center; align-items: center; color: var(--text-color); font-size: 18px; transition: 0.3s; z-index: 1001; }

    #theme-wrapper { width: 24px; height: 24px; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; }

    .lang-menu { position: absolute; top: 0; right: 115px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 5px; display: flex; flex-direction: column; gap: 4px; visibility: hidden; opacity: 0; transform: translateX(10px); transition: 0.3s; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .lang-menu.show { visibility: visible; opacity: 1; transform: translateX(0); }
    .lang-tab { padding: 10px 16px; border-radius: 8px; border: none; background: transparent; color: var(--text-dim); font-size: 12px; font-weight: 800; cursor: pointer; text-align: center; min-width: 110px; }
    .lang-tab.selected { background: var(--accent-color); color: white; }

    .card { background: var(--card-bg); border-radius: 30px; border: 1px solid var(--border-color); width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 40px; }
    .banner { width: 100%; height: 85px; background: linear-gradient(135deg, var(--panel-bg) 0%, var(--bg-color) 100%); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; text-align: center; }
    .banner h1 { font-size: 14px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-color); font-weight: 900; }
    .content { padding: 20px; }

    .section-label { font-size: 10px; font-weight: 800; color: var(--accent-color); margin-bottom: 8px; display: block; text-transform: uppercase; }
    .format-box { background: var(--input-bg); padding: 12px; border-radius: 20px; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; margin-bottom: 12px; }
    .dot { width: 100%; aspect-ratio: 1; border-radius: 6px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
    .style-row { display: flex; gap: 8px; }
    .btn-style { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-color); font-size: 12px; cursor: pointer; font-weight: bold; }

    input[type="text"], input[type="number"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); background: var(--input-bg); border-radius: 12px; color: var(--text-color); margin-bottom: 10px; outline: none; font-size: 14px; font-family: inherit; }
    textarea { resize: vertical; min-height: 80px; }

    .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .input-group label { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; display: block; font-weight: 700; }

    .section-header { display: flex; align-items: center; justify-content: space-between; margin: 25px 0 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
    .add-btn { background: var(--panel-bg); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 6px 14px; border-radius: 10px; font-size: 11px; cursor: pointer; font-weight: 800; }
    
    .dynamic-panel { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 18px; margin-bottom: 20px; position: relative; }
    .remove-btn { position: absolute; top: -10px; right: -10px; width: 34px; height: 34px; background: var(--card-bg); color: var(--danger); border: 1px solid var(--border-color); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    .uuid-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .uuid-row input { margin-bottom: 0; }
    .bolt-btn { background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--accent-color); width: 44px; height: 44px; border-radius: 12px; cursor: pointer; }

    .switch-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--input-bg); border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 10px; }
    .switch-label { font-size: 13px; font-weight: 600; }
    .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    /* AQUI ESTÁ EL CAMBIO DE COLOR A AZUL (accent-color) */
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(16px); }

    .export-mode-container { background: var(--panel-bg); padding: 5px; border-radius: 15px; display: flex; position: relative; border: 1px solid var(--border-color); margin-top: 30px; cursor: pointer; height: 50px; }
    .export-mode-thumb { position: absolute; top: 5px; left: 5px; width: 50%; height: 38px; background: var(--card-bg); border-radius: 11px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 1; border: 1px solid var(--border-color); }
    .export-mode-option { flex: 1; display: flex; align-items: center; justify-content: center; z-index: 2; font-weight: 800; font-size: 12px; color: var(--text-dim); transition: color 0.3s; user-select: none; }
    .export-mode-container.mode-json .export-mode-thumb { transform: translateX(100%) translateX(-10px); }
    .export-mode-container.mode-pack .option-pack { color: var(--accent-color); }
    .export-mode-container.mode-json .option-json { color: var(--accent-color); }

    .mc-preview { background: #313233; padding: 15px; border-radius: 8px; display: flex; gap: 15px; border: 2px solid #545454; align-items: center; color: white; margin-top: 5px; }
    #previewIcon { width: 64px; height: 64px; background: #555; border: 2px solid #fff; object-fit: cover; }
    #vTitle { font-family: 'MojanglesLocal', sans-serif !important; font-size: 18px; text-shadow: 2px 2px 0px #3f3f3f; }
    
    .c-0{color:#000} .c-1{color:#00A} .c-2{color:#0A0} .c-3{color:#0AA} .c-4{color:#A00} .c-5{color:#A0A} .c-6{color:#FA0} .c-7{color:#AAA} .c-8{color:#555} .c-9{color:#55F} .c-a{color:#5F5} .c-b{color:#5FF} .c-c{color:#F55} .c-d{color:#F5F} .c-e{color:#FF5} .c-f{color:#FFF}
    .mc-b{font-weight:900; text-shadow: 2px 2px 0px #3f3f3f !important;} .mc-i{font-style:italic}

    .export-btn { width: 100%; height: 55px; background: var(--accent-color); color: white !important; border: none; border-radius: 15px; font-weight: 900; margin-top: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; }

    #cropperModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    .crop-container { width: 100%; max-width: 400px; aspect-ratio: 1; background: #000; border-radius: 12px; overflow: hidden; }

    .type-badge { font-size: 9px; background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 8px; text-transform: uppercase; font-weight: 800; }
  </style>
</head>
<body>

  <div class="top-controls">
    <div class="lang-menu" id="langMenu">
      <button class="lang-tab selected" id="tab-es" onclick="setLang('es')">Español</button>
      <button class="lang-tab" id="tab-en" onclick="setLang('en')">English</button>
    </div>
    <button class="square-btn" id="langBtn" onclick="toggleLangMenu()"><i class="fa-solid fa-globe"></i></button>
    <button class="square-btn" onclick="toggleTheme()">
      <div id="theme-wrapper">
        <svg id="theme-svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg>
      </div>
    </button>
  </div>

  <div class="card">
    <div class="banner"><h1 data-i18n="appTitle">Base .mcpack Generator</h1></div>
    <div class="content">
      <label class="section-label" data-i18n="labelIcon">Icono</label>
      <label onclick="document.getElementById('iconInput').click()" style="display:flex; align-items:center; justify-content:center; gap:10px; padding:14px; background:var(--panel-bg); border:2px dashed var(--border-color); border-radius:15px; cursor:pointer; margin-bottom:20px;">
        <i class="fa-solid fa-upload" style="color:var(--accent-color)"></i> <span data-i18n="uploadBtn">Subir Imagen</span>
      </label>
      <input type="file" id="iconInput" accept="image/png, image/jpeg" style="display:none">

      <div class="format-box">
        <div class="color-grid" id="colorGrid"></div>
        <div class="style-row">
          <button class="btn-style" onmousedown="insertFormat(event, 'l')" data-i18n="bold">Negrita</button>
          <button class="btn-style" onmousedown="insertFormat(event, 'o')" data-i18n="italic">Italic</button>
          <button class="btn-style" onmousedown="insertFormat(event, 'r')" style="color:var(--danger)" data-i18n="reset">Reset</button>
        </div>
      </div>

      <input type="text" id="inName" class="mc-input" data-placeholder="phName" autocomplete="off" value="">
      <input type="text" id="inAuthor" class="mc-input" data-placeholder="phAuthor" autocomplete="off" value="">
      <input type="text" id="inDesc" class="mc-input" data-placeholder="phDesc" autocomplete="off" value="">

      <div class="config-grid">
        <div class="input-group">
          <label data-i18n="packVer">Pack Version</label>
          <input type="text" id="inPackVer" value="1.0.0" placeholder="e.g. 1.0.0">
        </div>
        <div class="input-group">
          <label data-i18n="minVer">Min Engine Version</label>
          <input type="text" id="inMinVer" value="1.21.0" placeholder="e.g. 1.21.0">
        </div>
      </div>
      
      <div class="switch-row">
        <span class="switch-label" data-i18n="pbrLabel">Ray Tracing (PBR)</span>
        <label class="switch">
          <input type="checkbox" id="pbrToggle" checked>
          <span class="slider"></span>
        </label>
      </div>

      <div class="mc-preview">
        <img id="previewIcon" src="https://via.placeholder.com/64?text=PNG">
        <div class="preview-info">
          <div id="vTitle" data-i18n="defTitle">Nombre del Pack</div>
          <div id="vAuthor" style="font-size:11px; color:#aaa;">Autor: -</div>
          <div id="vDesc" style="font-size:12px; color:#ccc;" data-i18n="defDesc">Descripción...</div>
        </div>
      </div>

      <div class="section-header">
          <span class="section-label" data-i18n="labelSub">Subpacks</span>
          <button class="add-btn" onclick="addSubpack()" data-i18n="addBtn">+ Añadir</button>
      </div>
      <div id="subpackContainer"></div>

      <div class="section-header">
          <span class="section-label" data-i18n="labelSettings">Configuración (Toggles)</span>
          <div style="display:flex; gap:5px;">
              <button class="add-btn" onclick="addSetting('toggle')" style="font-size:9px">Toggle</button>
              <button class="add-btn" onclick="addSetting('slider')" style="font-size:9px">Slider</button>
              <button class="add-btn" onclick="addSetting('label')" style="font-size:9px">Label</button>
          </div>
      </div>
      <div id="settingsContainer"></div>

      <div class="export-mode-container mode-pack" id="exportSwitch" onclick="toggleExportMode()">
        <div class="export-mode-thumb"></div>
        <div class="export-mode-option option-pack">.MCPACK</div>
        <div class="export-mode-option option-json">MANIFEST.JSON</div>
      </div>

      <button class="export-btn" onclick="exportPack()">
        <i class="fa-solid fa-file-export"></i> <span id="exportText" data-i18n="exportBtn">EXPORTAR .MCPACK</span>
      </button>
    </div>
  </div>

  <div id="cropperModal">
    <div class="crop-container"><img id="imageToCrop"></div>
    <div style="margin-top:20px; display:flex; gap:20px;">
        <button onclick="closeCropper()" class="square-btn" style="background:var(--danger); color:white;"><i class="fa-solid fa-xmark"></i></button>
        <button id="btnConfirmCrop" class="square-btn" style="background:var(--accent-color); color:white;"><i class="fa-solid fa-check"></i></button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    let currentLang = 'es', rot = 0, lastInput = document.getElementById('inName');
    let exportMode = 'mcpack';
    const clickSound = new Audio('click.ogg');

    const translations = {
      es: { appTitle: "Base .mcpack Generator", labelIcon: "Icono", uploadBtn: "Subir Imagen", bold: "Negrita", italic: "Italic", reset: "Reset", phName: "Nombre del Pack", phAuthor: "Autor", phDesc: "Descripción", defTitle: "Nombre del Pack", defDesc: "Descripción...", labelSub: "Subpacks", addBtn: "+ Añadir", exportBtn: "EXPORTAR .MCPACK", exportJson: "EXPORTAR MANIFEST", labelSettings: "Configuración", minVer: "Versión Min. Juego", packVer: "Versión del Pack", pbrLabel: "Soporte PBR" },
      en: { appTitle: "Base .mcpack Generator", labelIcon: "Icon", uploadBtn: "Upload Image", bold: "Bold", italic: "Italic", reset: "Reset", phName: "Pack Name", phAuthor: "Author", phDesc: "Description", defTitle: "Pack Name", defDesc: "Description...", labelSub: "Subpacks", addBtn: "+ Add", exportBtn: "EXPORT .MCPACK", exportJson: "EXPORT MANIFEST", labelSettings: "Settings", minVer: "Min Engine Version", packVer: "Pack Version", pbrLabel: "PBR Support" }
    };

    function toggleTheme() {
      const b = document.body, w = document.getElementById('theme-wrapper');
      rot += 180; w.style.transform = `rotate(${rot}deg)`;
      b.classList.toggle('light');
      setTimeout(() => {
        w.innerHTML = b.classList.contains('light') ? 
        '<i class="fa-solid fa-moon" style="font-size:20px; transform: rotate(415deg);"></i>' : 
        '<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg>';
      }, 150);
    }

    document.addEventListener('mousedown', (e) => {
        if (e.target.closest('button') || e.target.closest('.dot') || e.target.closest('.lang-tab') || e.target.closest('.switch') || e.target.closest('.export-mode-container')) {
            clickSound.currentTime = 0; clickSound.play().catch(()=>{});
        }
    });

    function toggleExportMode() {
        const el = document.getElementById('exportSwitch');
        const txt = document.getElementById('exportText');
        if(exportMode === 'mcpack') {
            exportMode = 'json';
            el.classList.replace('mode-pack', 'mode-json');
            txt.innerText = translations[currentLang].exportJson;
        } else {
            exportMode = 'mcpack';
            el.classList.replace('mode-json', 'mode-pack');
            txt.innerText = translations[currentLang].exportBtn;
        }
    }

    const mcColors = {'0':'#000','1':'#00A','2':'#0A0','3':'#0AA','4':'#A00','5':'#A0A','6':'#FA0','7':'#AAA','8':'#555','9':'#55F','a':'#5F5','b':'#5FF','c':'#F55','d':'#F5F','e':'#FF5','f':'#FFF'};
    const grid = document.getElementById('colorGrid');
    Object.keys(mcColors).forEach(c => {
        const d = document.createElement('div'); d.className = 'dot'; d.style.background = mcColors[c];
        d.onmousedown = (e) => insertFormat(e, c);
        grid.appendChild(d);
    });

    function toggleLangMenu() { document.getElementById('langMenu').classList.toggle('show'); }
    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('selected'));
        document.getElementById(`tab-${lang}`).classList.add('selected');
              updateTexts(); toggleLangMenu();
    }
    function updateTexts() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if(translations[currentLang][key]) el.innerHTML = translations[currentLang][key];
      });
      document.querySelectorAll('[data-placeholder]').forEach(el => {
          const key = el.getAttribute('data-placeholder');
          if(translations[currentLang][key]) el.placeholder = translations[currentLang][key];
      });
      const btnTxt = document.getElementById('exportText');
      btnTxt.innerText = exportMode === 'mcpack' ? translations[currentLang].exportBtn : translations[currentLang].exportJson;
    }

    function insertFormat(e, c) {
        e.preventDefault();
        const s = lastInput.selectionStart;
        lastInput.value = lastInput.value.slice(0,s) + "§" + c + lastInput.value.slice(lastInput.selectionEnd);
        lastInput.focus();
        lastInput.setSelectionRange(s+2, s+2);
        lastInput.dispatchEvent(new Event('input'));
    }

    document.querySelectorAll('.mc-input').forEach(i => {
        i.onfocus = () => lastInput = i;
        i.oninput = () => {
            const parsed = parseMC(i.value);
            if(i.id === 'inName') document.getElementById('vTitle').innerHTML = parsed || translations[currentLang].defTitle;
            if(i.id === 'inAuthor') document.getElementById('vAuthor').innerText = (currentLang==='es'?"Autor: ":"Author: ") + (i.value || "-");
            if(i.id === 'inDesc') document.getElementById('vDesc').innerHTML = parsed || translations[currentLang].defDesc;
        };
    });

    function parseMC(text) {
        let parts = text.split('§'), html = parts[0], cC = "", b = false, it = false;
        for(let i=1; i<parts.length; i++) {
            let p = parts[i], code = p[0].toLowerCase(), cont = p.slice(1);
            if(mcColors[code]) cC = "c-"+code;
            else if(code === 'l') b = true;
            else if(code === 'o') it = true;
            else if(code === 'r') { cC=""; b=false; it=false; }
            html += `<span class="${cC} ${b?'mc-b':''} ${it?'mc-i':''}">${cont}</span>`;
        }
        return html;
    }

    function addSetting(type) {
        const div = document.createElement('div'); 
        div.className=`dynamic-panel setting-item setting-${type}`;
        div.dataset.type = type;
        
        let content = `<button class="remove-btn" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>
                       <span class="type-badge">${type}</span>`;
        
        if (type === 'label') {
             content += `<div class="input-group"><label>Text Content</label><textarea class="set-text" placeholder="Your label text here..."></textarea></div>`;
        } else {
            content += `<div class="input-group"><label>Display Text</label><input type="text" class="set-text" placeholder="e.g. My Setting"></div>
                        <div class="input-group"><label>Variable Name</label><input type="text" class="set-name" placeholder="e.g. um:my_var"></div>`;
        }

        if (type === 'toggle') {
            content += `<div class="switch-row" style="margin-bottom:0; padding:10px;"><span class="switch-label">Default ON</span><label class="switch"><input type="checkbox" class="set-def"><span class="slider"></span></label></div>`;
        } else if (type === 'slider') {
            content += `<div class="config-grid">
                            <div class="input-group"><label>Min</label><input type="number" class="set-min" value="0"></div>
                            <div class="input-group"><label>Max</label><input type="number" class="set-max" value="10"></div>
                            <div class="input-group"><label>Step</label><input type="number" class="set-step" value="1"></div>
                            <div class="input-group"><label>Default</label><input type="number" class="set-def-val" value="0"></div>
                        </div>`;
        }
        
        div.innerHTML = content;
        document.getElementById('settingsContainer').appendChild(div);
    }

    function addSubpack(folder="", name="", tier=1) {
        const div = document.createElement('div'); div.className='dynamic-panel subpack-item';
        div.innerHTML = `<button class="remove-btn" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>
        <input type="text" class="sub-folder" placeholder="Folder Name" value="${folder}">
        <input type="text" class="sub-name" placeholder="Subpack Name" value="${name}">
        <input type="number" class="sub-memory" placeholder="Memory Tier" value="${tier}">`;
        document.getElementById('subpackContainer').appendChild(div);
    }

    document.getElementById('iconInput').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById('imageToCrop').src = ev.target.result;
            document.getElementById('cropperModal').style.display = 'flex';
            const cropper = new Cropper(document.getElementById('imageToCrop'), {aspectRatio: 1});
            document.getElementById('btnConfirmCrop').onclick = () => {
                document.getElementById('previewIcon').src = cropper.getCroppedCanvas({width:512, height:512}).toDataURL();
                cropper.destroy(); document.getElementById('cropperModal').style.display = 'none';
            };
        };
        reader.readAsDataURL(file);
    };

    function closeCropper() { document.getElementById('cropperModal').style.display = 'none'; }

    async function exportPack() {
        const zip = new JSZip();

        let minVer = document.getElementById('inMinVer').value || "1.21.0";
        let packVer = document.getElementById('inPackVer').value || "1.0.0";

        const name = document.getElementById('inName').value || "Pack";
        const desc = document.getElementById('inDesc').value || "";
        const authors = document.getElementById('inAuthor').value.split(',').map(s => s.trim()).filter(s => s !== "");
        const uuidHeader = self.crypto.randomUUID();
        const uuidModule = self.crypto.randomUUID();

        const manifest = {};

        manifest["format_version"] = 3;

        manifest["header"] = {
            "description": desc,
            "name": name,
            "uuid": uuidHeader,
            "version": packVer,
            "min_engine_version": minVer
        };

        if (authors.length > 0) {
            manifest["metadata"] = { "authors": authors };
        }

        if(document.getElementById('pbrToggle').checked) {
            manifest["capabilities"] = ["pbr"];
        }

        manifest["modules"] = [
            {
                "type": "resources",
                "uuid": uuidModule,
                "version": packVer
            }
        ];

        const subpackElements = document.querySelectorAll('.subpack-item');
        if(subpackElements.length > 0) {
            const subpacksData = [];
            subpackElements.forEach(el => {
                const folder = el.querySelector('.sub-folder').value || "default";
                const sName = el.querySelector('.sub-name').value || "Unnamed";
                const memory = parseInt(el.querySelector('.sub-memory').value) || 0;
                
                subpacksData.push({ 
                    "folder_name": folder, 
                    "name": sName, 
                    "memory_performance_tier": memory 
                });
                
                if(exportMode === 'mcpack') zip.folder("subpacks/" + folder);
            });
            manifest["subpacks"] = subpacksData;
        }

        const settingElements = document.querySelectorAll('.setting-item');
        if (settingElements.length > 0) {
            const settingsData = [];
            
            settingElements.forEach(el => {
                const type = el.dataset.type;
                const text = el.querySelector('.set-text').value || "";
                const entry = { "type": type, "text": text };
                
                if (type !== 'label') entry["name"] = el.querySelector('.set-name').value || "var";

                if (type === 'toggle') {
                    entry["default"] = el.querySelector('.set-def').checked;
                } else if (type === 'slider') {
                    entry["default"] = parseFloat(el.querySelector('.set-def-val').value) || 0;
                    entry["min"] = parseFloat(el.querySelector('.set-min').value) || 0;
                    entry["max"] = parseFloat(el.querySelector('.set-max').value) || 10;
                    entry["step"] = parseFloat(el.querySelector('.set-step').value) || 1;
                }
                settingsData.push(entry);
            });

            manifest["settings"] = settingsData;
        }

        if (exportMode === 'json') {
            const blob = new Blob([JSON.stringify(manifest, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "manifest.json"; a.click();
        } else {
            zip.file("manifest.json", JSON.stringify(manifest, null, 2));
            const icon = document.getElementById('previewIcon').src;
            if(icon.includes('base64')) zip.file("pack_icon.png", icon.split(',')[1], {base64:true});
            
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Pack.mcpack"; a.click();
        }
    }

    window.onload = () => {
        updateTexts();
    };
  </script>
</body>
</html>
